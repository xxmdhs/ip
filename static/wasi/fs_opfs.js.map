{"version":3,"sources":["../src/fs_opfs.ts"],"sourcesContent":["import * as wasi from \"./wasi_defs.js\";\nimport { Fd, Inode } from \"./fd.js\";\n\n// Shim for https://developer.mozilla.org/en-US/docs/Web/API/FileSystemSyncAccessHandle\n// This is not part of the public interface.\nexport interface FileSystemSyncAccessHandle {\n  close(): void;\n  flush(): void;\n  getSize(): number;\n  read(buffer: ArrayBuffer | ArrayBufferView, options?: { at: number }): number;\n  truncate(to: number): void;\n  write(\n    buffer: ArrayBuffer | ArrayBufferView,\n    options?: { at: number },\n  ): number;\n}\n\n// Synchronous access to an individual file in the origin private file system.\n// Only allowed inside a WebWorker.\nexport class SyncOPFSFile extends Inode {\n  handle: FileSystemSyncAccessHandle;\n  readonly: boolean;\n\n  // FIXME needs a close() method to be called after start() to release the underlying handle\n  constructor(\n    handle: FileSystemSyncAccessHandle,\n    options?: Partial<{\n      readonly: boolean;\n    }>,\n  ) {\n    super();\n    this.handle = handle;\n    this.readonly = !!options?.readonly;\n  }\n\n  path_open(oflags: number, fs_rights_base: bigint, fd_flags: number) {\n    if (\n      this.readonly &&\n      (fs_rights_base & BigInt(wasi.RIGHTS_FD_WRITE)) ==\n        BigInt(wasi.RIGHTS_FD_WRITE)\n    ) {\n      // no write permission to file\n      return { ret: wasi.ERRNO_PERM, fd_obj: null };\n    }\n\n    if ((oflags & wasi.OFLAGS_TRUNC) == wasi.OFLAGS_TRUNC) {\n      if (this.readonly) return { ret: wasi.ERRNO_PERM, fd_obj: null };\n      this.handle.truncate(0);\n    }\n\n    const file = new OpenSyncOPFSFile(this);\n    if (fd_flags & wasi.FDFLAGS_APPEND) file.fd_seek(0n, wasi.WHENCE_END);\n    return { ret: wasi.ERRNO_SUCCESS, fd_obj: file };\n  }\n\n  get size(): bigint {\n    return BigInt(this.handle.getSize());\n  }\n\n  stat(): wasi.Filestat {\n    return new wasi.Filestat(this.ino, wasi.FILETYPE_REGULAR_FILE, this.size);\n  }\n}\n\nexport class OpenSyncOPFSFile extends Fd {\n  file: SyncOPFSFile;\n  position: bigint = 0n;\n  ino: bigint;\n\n  constructor(file: SyncOPFSFile) {\n    super();\n    this.file = file;\n    this.ino = Inode.issue_ino();\n  }\n\n  fd_allocate(offset: bigint, len: bigint): number {\n    if (BigInt(this.file.handle.getSize()) > offset + len) {\n      // already big enough\n    } else {\n      // extend\n      this.file.handle.truncate(Number(offset + len));\n    }\n    return wasi.ERRNO_SUCCESS;\n  }\n\n  fd_fdstat_get(): { ret: number; fdstat: wasi.Fdstat | null } {\n    return { ret: 0, fdstat: new wasi.Fdstat(wasi.FILETYPE_REGULAR_FILE, 0) };\n  }\n\n  fd_filestat_get(): { ret: number; filestat: wasi.Filestat } {\n    return {\n      ret: 0,\n      filestat: new wasi.Filestat(\n        this.ino,\n        wasi.FILETYPE_REGULAR_FILE,\n        BigInt(this.file.handle.getSize()),\n      ),\n    };\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  fd_filestat_set_size(size: bigint): number {\n    this.file.handle.truncate(Number(size));\n    return wasi.ERRNO_SUCCESS;\n  }\n\n  fd_read(size: number): { ret: number; data: Uint8Array } {\n    const buf = new Uint8Array(size);\n    const n = this.file.handle.read(buf, { at: Number(this.position) });\n    this.position += BigInt(n);\n    return { ret: 0, data: buf.slice(0, n) };\n  }\n\n  fd_seek(\n    offset: number | bigint,\n    whence: number,\n  ): { ret: number; offset: bigint } {\n    let calculated_offset: bigint;\n    switch (whence) {\n      case wasi.WHENCE_SET:\n        calculated_offset = BigInt(offset);\n        break;\n      case wasi.WHENCE_CUR:\n        calculated_offset = this.position + BigInt(offset);\n        break;\n      case wasi.WHENCE_END:\n        calculated_offset = BigInt(this.file.handle.getSize()) + BigInt(offset);\n        break;\n      default:\n        return { ret: wasi.ERRNO_INVAL, offset: 0n };\n    }\n    if (calculated_offset < 0) {\n      return { ret: wasi.ERRNO_INVAL, offset: 0n };\n    }\n    this.position = calculated_offset;\n    return { ret: wasi.ERRNO_SUCCESS, offset: this.position };\n  }\n\n  fd_write(data: Uint8Array): { ret: number; nwritten: number } {\n    if (this.file.readonly) return { ret: wasi.ERRNO_BADF, nwritten: 0 };\n\n    // don't need to extend file manually, just write\n    const n = this.file.handle.write(data, { at: Number(this.position) });\n    this.position += BigInt(n);\n    return { ret: wasi.ERRNO_SUCCESS, nwritten: n };\n  }\n\n  fd_sync(): number {\n    this.file.handle.flush();\n    return wasi.ERRNO_SUCCESS;\n  }\n}\n"],"names":["wasi","Fd","Inode","SyncOPFSFile","path_open","oflags","fs_rights_base","fd_flags","readonly","BigInt","RIGHTS_FD_WRITE","ret","ERRNO_PERM","fd_obj","OFLAGS_TRUNC","handle","truncate","file","OpenSyncOPFSFile","FDFLAGS_APPEND","fd_seek","WHENCE_END","ERRNO_SUCCESS","size","getSize","stat","Filestat","ino","FILETYPE_REGULAR_FILE","constructor","options","fd_allocate","offset","len","Number","fd_fdstat_get","fdstat","Fdstat","fd_filestat_get","filestat","fd_filestat_set_size","fd_read","buf","Uint8Array","n","read","at","position","data","slice","whence","calculated_offset","WHENCE_SET","WHENCE_CUR","ERRNO_INVAL","fd_write","ERRNO_BADF","nwritten","write","fd_sync","flush","issue_ino"],"mappings":"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"}