<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Get All Local IPs (including Public IPv6) with WebRTC</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            padding: 2em;
            background-color: #f4f4f9;
            color: #333;
            max-width: 800px;
            margin: auto;
        }
        h1 {
            color: #1a237e;
        }
        #ip-list {
            list-style-type: none;
            padding: 0;
        }
        #ip-list li {
            background-color: #ffffff;
            border: 1px solid #ddd;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-family: "Courier New", Courier, monospace;
            font-size: 1.1em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #ip-list li .ip-type {
            font-size: 0.8em;
            font-family: sans-serif;
            color: #555;
            background-color: #eee;
            padding: 3px 8px;
            border-radius: 10px;
        }
        #ip-list li.detecting {
            font-style: italic;
            color: #777;
        }
        #ip-list li.error {
            background-color: #ffebee;
            color: #c62828;
            border-color: #e57373;
        }
        p.note {
            font-size: 0.9em;
            color: #666;
            border-left: 3px solid #64b5f6;
            padding-left: 1em;
            margin-top: 2em;
        }
    </style>
</head>
<body>
    <h1>Discovered IP Addresses (Host Candidates):</h1>
    <ul id="ip-list">
        <li class="detecting">Detecting...</li>
    </ul>

    <p class="note">
        This list shows all IP addresses found directly on your network interfaces (Host Candidates). 
        This includes local IPv4, local IPv6 (like <code>fe80::...</code>), and potentially your <strong>public IPv6 address</strong> if your network supports it.
        No external servers (STUN) were used.
    </p>

    <script>
        /**
         * 这是一个自执行的匿名函数 (IIFE)，用于封装代码并立即执行。
         */
        (function() {
            /**
             * 使用 WebRTC RTCPeerConnection 获取用户的所有主机候选 IP 地址。
             * 这包括本地 IPv4、本地 IPv6 和可能直接绑定在网卡上的公共 IPv6 地址。
             * @returns {Promise<string[]>} 一个 Promise，解析后返回一个包含所有 IP 地址的数组。
             */
            function getAllHostIPs() {
                return new Promise((resolve, reject) => {
                    const ips = new Set();
                    const RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;

                    if (!RTCPeerConnection) {
                        reject(new Error("WebRTC is not supported by this browser."));
                        return;
                    }

                    const pc = new RTCPeerConnection();

                    pc.onicecandidate = (event) => {
                        if (!event || !event.candidate) {
                            if (ips.size > 0) {
                                pc.close();
                                resolve(Array.from(ips));
                            }
                            return;
                        }

                        // ICE candidate 字符串格式通常是 "candidate:..."
                        // 我们关注的是其中的 IP 地址字段
                        // 示例: "candidate:1234 1 udp 2122252543 192.168.1.100 9786 typ host ..."
                        const candidateString = event.candidate.candidate;
                        const parts = candidateString.split(' ');
                        
                        // IP 地址通常是第 5 个字段 (索引为 4)
                        const ipAddress = parts[4];

                        // 确保我们确实获取到了一个看似 IP 的地址
                        if (ipAddress && ipAddress.indexOf('.') > -1 || ipAddress.indexOf(':') > -1) {
                            // 过滤掉 localhost loopback 地址
                            if (ipAddress !== '127.0.0.1' && ipAddress !== '::1') {
                                ips.add(ipAddress);
                            }
                        }
                    };

                    pc.createDataChannel('');
                    pc.createOffer()
                        .then(offer => pc.setLocalDescription(offer))
                        .catch(err => reject(err));

                    setTimeout(() => {
                        if (ips.size > 0) {
                            pc.close();
                            resolve(Array.from(ips));
                        } else {
                            pc.close();
                            reject(new Error("Timed out. Could not find any IP addresses."));
                        }
                    }, 1000);
                });
            }

            /**
             * 辅助函数，用于判断 IP 地址的类型。
             * @param {string} ip - IP 地址字符串.
             * @returns {string} IP 类型描述.
             */
            function getIpType(ip) {
                if (ip.includes(':')) { // IPv6
                    if (ip.toLowerCase().startsWith('fe80::')) {
                        return 'IPv6 Link-Local';
                    }
                    if (ip.toLowerCase().startsWith('fd')) {
                        return 'IPv6 Unique Local';
                    }
                    // 所有其他 IPv6 地址都被认为是公共的 (GUA)
                    return 'IPv6 Public (GUA)';
                } else { // IPv4
                    const parts = ip.split('.').map(Number);
                    if (parts[0] === 10 || 
                        (parts[0] === 172 && parts[1] >= 16 && parts[1] <= 31) || 
                        (parts[0] === 192 && parts[1] === 168) ||
                        (parts[0] === 169 && parts[1] === 254)) {
                        return 'IPv4 Private';
                    }
                    // 理论上，没有STUN不应该发现公网IPv4，但以防万一
                    return 'IPv4 Public';
                }
            }
            
            // --- 执行代码并显示结果 ---
            document.addEventListener("DOMContentLoaded", () => {
                const ipListElement = document.getElementById('ip-list');

                getAllHostIPs()
                    .then(ips => {
                        ipListElement.innerHTML = '';
                        if (ips.length > 0) {
                            ips.forEach(ip => {
                                const li = document.createElement('li');
                                const ipType = getIpType(ip);
                                li.innerHTML = `<span>${ip}</span> <span class="ip-type">${ipType}</span>`;
                                ipListElement.appendChild(li);
                            });
                        } else {
                            const li = document.createElement('li');
                            li.textContent = 'No host IP addresses found. WebRTC might be disabled or restricted.';
                            ipListElement.appendChild(li);
                        }
                    })
                    .catch(error => {
                        console.error(error);
                        ipListElement.innerHTML = '';
                        const li = document.createElement('li');
                        li.className = 'error';
                        li.textContent = `Error: ${error.message}`;
                        ipListElement.appendChild(li);
                    });
            });
        })();
    </script>
</body>
</html>